module Aoc13 exposing (..)

import Browser exposing (Document)
import Html exposing (Html)
import Html.Attributes
import Html.Events exposing (onClick)
import Dict exposing (Dict)
import Array exposing (Array)
import Set exposing (Set)
import Array2D exposing (Array2D)
import Html exposing (text)
import Time

defaultTickInterval : Float
defaultTickInterval = 100

-- MAIN

main =
  Browser.document
    { init = init
    , view = view
    , update = update
    , subscriptions = subscriptions }

-- MODEL

type DataSource = Input | Sample | Sample2

type alias Pos = (Int, Int)

type Dir = N | W | S | E

type Junction = Left | Forward | Right

type alias Cart = 
  { dir : Dir 
  , pos : Pos 
  , switches : Junction
  }

type alias Model = 
  { mine : Array2D Char
  , carts : List Cart 
  , dataSource : DataSource
  , paused : Bool 
  , finished : Bool 
  , tickInterval : Float 
  , message : String
  , counter : Int 
  , debug : String }

sample : String
sample = """/->-\\        
|   |  /----\\
| /-+--+-\\  |
| | |  | v  |
\\-+-/  \\-+--/
  \\------/   """

sample2 : String 
sample2 = """/>-<\\  
|   |  
| /<+-\\
| | | v
\\>+</ |
  |   ^
  \\<->/"""

input : String
input = """                    /--------------------------------------------------\\                                        /----------------\\                    
          /---------+--------------------------------------------------+-------------\\                          |                |/-------------\\     
          |   /-----+---------------------------------\\                |          /--+--------------------------+-------\\        ||             |     
          |   |     |                                 |        /-------+----------+--+--------------------------+-------+---\\    ||             |     
          |   |     |              /------------------+--------+-------+\\         |  |                          |       |   |    ||             |     
          |   |     |    /---------+------------------+--------+--\\    ||         |  |                    /-----+-------+---+----++-------------+---\\ 
          |   |     |    |         |                  |        |  |    ||         |  |                    |     |       |   |    ||             |   | 
        /-+---+-----+----+---\\     |                  |        |  |    ||         |/-+--------------------+-----+-------+---+----++-------------+\\  | 
        | |   |     |    |   |     |   /--------------+--------+--+----++---------++-+--------------------+-----+------\\|   |    ||             ||  | 
        | |/--+-----+----+---+-----+---+--------------+--------+--+----++\\        || |                    |     |      ||   |    ||             ||  | 
        | ||  |     |    |   |     |   |              |        |  |   /+++--------++-+--------------------+\\    |      ||   |    ||             ||  | 
        | ||  |   /-+----+---+-----+---+--------------+--\\     |  |   ||||        || |  /-----------------++\\   |      ||   |    ||             ||  | 
        | || /+---+-+--\\ |   |     |   |              |  |     |  |   ||||        || |  |                 |||   |      ||   |    ||             ||  | 
      /-+-++-++---+-+--+-+---+-----+---+--------------+--+-----+--+---++++--------++-+--+----------\\      |||   |      ||   |    ||             ||  | 
      | | || ||   | |  | |   |     |/--+--------------+\\ |     |  |   ||||        || |  |          |      |||   |      ||   |    |\\-------------/|  | 
      | | || ||   | |  | |   |/----++--+--------------++-+-----+--+---++++--------++-+--+----------+---\\  |||   |      ||   |    |               |  | 
      | | || ||  /+-+--+-+---++----++--+--------------++-+-----+--+---++++--------++-+--+----------+---+--+++\\  |      ||   |    |               |  | 
      | | || ||  || |  | |   ||    ||  |       /------++-+-----+--+---++++--------++-+--+----------+---+--++++--+---\\  ||   |    |               |  | 
      | | || ||  || |  | |   ||    ||  |       |      || |     |  |   ||||        || |  |          |   |  ||||  |   |  ||   |    |               |  | 
      | | || ||  || |  | |   ||    || /+-------+------++-+-----+--+---++++---->---++-+--+----------+---+--++++--+---+--++---+-\\  |               |  | 
      | | || ||  || |  | |   ||    || ||       |      || |     |  |   ||||        || |  |          |   |  ||||  |   |  ||   | |  |               |  | 
      | | || ||  || |  | |   ||    || ||       |      || |     |  |   ||||        || |  |          |   |  ||||  |   |  ||   | |  |               |  | 
      | | ||/++--++-+--+-+---++\\   || ||       |      || |     |  |   ||||        || |  |          |   |  ||||  |   |  ||   | |  |               |  | 
     /+-+-+++++\\ || |  | |   |||   || ||       |      || |/----+--+---++++--------++-+--+----------+---+--++++--+---+--++---+-+-\\|               |  | 
 /---++-+-++++++-++-+--+-+---+++---++-++----->-+------++-++----+--+---++++--------++\\|  |    /-----+---+--++++--+---+--++---+-+-++---------------+\\ | 
 |   || | |||||| || \\--+-+---+++---++-++-------+------++-++----+--+---+/||        |\\++--+----+-----+---+--++++--+---+--++---+-+-++---------------/| | 
 |   || | |||||| ||    | |   |||   || ||     /-+------++-++----+--+---+-++--------+-++--+----+-----+---+--++++--+---+--++--\\|/+-++------------\\   | | 
 |   || | |||||| ||    | |   |||   || ||     | |  /---++-++----+-\\|  /+-++--------+-++--+----+-----+-\\ |  ||||  |   |  ||  |||| ||            |   | | 
 |   || | |||||| ||    | |   |||   || ||     | |  |   || ||   /+-++--++-++--\\     | ||/-+----+-----+-+-+--++++--+---+--++--++++-++--\\         |   | | 
 |   |\\-+-++++++-++----+-+---+++---++-++-----+-+--+---++-++---++-++--++-++--+-----+-+++-+----+-----/ | |  ||||  |   |  ||  |||| ||  |         |   | | 
 |   |  | |||||| ||    | |   |||   || ||     | |  |   || ||   || ||  || ||  |     | ||| |    |       | |  ||||  |   | /++--++++-++--+--------\\|   | | 
 |   |  | |||||| ||    | |   |||   || ||  /--+-+--+---++-++---++-++--++-++--+-----+-+++-+----+--\\    | |  ||||  |   | |||  |||| ||  |        ||   | | 
 |   |  | |\\++++-++----+-+---+++---++-++--+--+-+--+---++-++---++-++--++-+/  |     | ||| |  /-+--+----+-+--++++--+---+-+++--++++-++--+----\\   ||   | | 
 |   |  | \\-++++-++----+-+---+++---++-++--+--+-+--+---++-++---++-++--++-+---+-----+-+/| |  | |  |/---+-+--++++--+---+-+++--++++-++-\\|    |   ||   | | 
 |   |  |   |||| \\+----+-+---+++---++-++--+--+-+--+---++-++---++-++--++-+---+-----+-+-+-+--+-+--++---+-+--+++/  |   | |||  |||| || ||    |   ||   | | 
 |   |  |   ||||  |    | |   |||   || ||  |  | |  |   || ||   || ||  || |   |     | | | |  | |  ||   | |  |||   |   | |||  |||| || ||    |   ||   | | 
 |   |  |   ||||  |    | |   |||  /++-++--+--+-+--+---++-++---++-++--++-+---+----\\| | | |  | |  ||   | |  |||   |   | |||  |||| || ||    |   ||   | | 
 |   |  \\---++++--+----+-+---/||  ||| ||  |  | |  |   || ||  /++-++--++-+\\  |    || | | |  | |  ||   | |  |||   |   | |||/-++++-++-++----+---++---+-+\\
 |   |      ||||  |    | |    ||  ||| ||  |  | |  |   || ||  ||| ||  || ||  |    || | | |  | |  ||   | | /+++---+---+\\|||| |||| || ||    |   ||   | ||
 |   |      ||||  |   /+-+----++--+++-++--+--+-+--+---++-++\\ ||| ||  || ||  | /--++-+-+-+-\\|/+--++---+-+-++++---+---++++++-++++-++-++----+---++--\\| ||
 |   \\------+++/  |   || |    ||  ||| ||/-+--+-+--+---++-+++-+++-++--++-++--+-+--++-+-+-+-++++--++---+-+-++++-\\ |   |||||| |||| || ||    |   ||  || ||
 |          |||   |   || |    ||  ||| ||| |  | |  |   || |||/+++-++--++-++--+-+--++-+-+-+-++++->++---+-+-++++-+-+---++++++-++++-++-++--\\ |   ||  || ||
 |          |||   |   || |    ||  ||| ||| \\--+-+--+---++-+++++++-++--++-++--+-+--++-+-+-+-++++--/|   | | |||| | |   |||||| |||| || ||  | |   ||  || ||
 |          |||  /+---++-+----++--+++-+++----+-+--+---++-+++++++-++--++-++--+-+--++-+-+-+-++++--\\|   | | |||| | |   |||||| |||| || ||  | |   ||  || ||
 |          |||  ||   || |    ||  ||| |||    | |  \\---++-+++++++-/|  || ||  | |  || | | | |\\++--++---+-+-++++-+-+---++++++-++++-++-++--+-/   ||  || ||
 |          |||  ||   || |    ||  ||v |||    | |      || |||||||  |  || ||  | |  || | | |/+-++--++---+-+-++++-+-+---++++++-++++-++-++-\\|     ||  || ||
 |          |||/-++---++-+----++--+++-+++----+-+------++-+++++++--+--++-++--+-+--++-+-+-+++-++--++---+-+-++++-+-+--\\|||||| ||||/++-++-++-\\   ||  || ||
 |          |||| ||   || |   /++--+++-+++----+-+------++-+++++++-\\|  \\+-++--+-+--++-+-+-+++-++--++---/ | |||| | |  ||||||| ||||||| || || |   ||  || ||
 |          |||| ||   || |   |||  ||| \\++----+-+------++-+++++++-++---+-++--+-+--++-+-+-+++-++--++-----+-++++-+-+--+++++++-+++/||| || || |   ||  || ||
 |          |||| ||   || |   |||  |||  ||    | |      || ||||||| ||   | ||  | |  || | | ||| ||  ||     | |||| | |  ||||||| ||| ||| || || |   ||  || ||
 |          |||| || /-++-+---+++--+++--++----+-+------++-+++++++-++---+-++--+-+--++-+-+-+++-++--++-----+-++++-+-+-\\||||||| ||| ||| || || |   ||  || ||
 |          |||| || | || |   |||  |||  ||    |/+------++-+++++++-++---+-++--+\\|  || | | ||| ||/-++-----+-++++-+-+-++++++++-+++-+++\\|| || |   ||  || ||
 |  /-------++++-++-+-++-+---+++--+++--++----+++------++-+++++++-++-\\ | ||  |||  || | | ||| ||| ||     | |||| | | |||||||| ||| |||||| || |   ||  || ||
 |  |       |||| || | || |   |||  |||  ||    |||      || ||||||| || | | ||  |||  || | | ||| ||| ||     | |||| | | |||||||| ||| |||||| || |   ||  || ||
 |  |       |||| || | || |   |||  |||  ||    |||      || ||||||| || | | ||  |||  || | | ||| ||| ||     | |||| | |/++++++++-+++-++++++-++-+-\\ ||  || ||
 |  |       |||| || | || |   |||  |||  ||    |||      || ||||||| || | ^ ||  |||  || | | ||| ||| ||     | |||| | |||||||||| ||| |||||| || | | ||  || ||
 |  |       |||| || | ||/+---+++--+++--++----+++\\     || ||||||| || | | ||  |||  || | | |^| ||| |\\-----+-++++-+-++++++++++-+++-++++/| || | | ||  || ||
 |  |       |||| || | ||||   |||  ||\\--++----++++-----+/ ||||||| || | | ||  |||  || | | ||| ||| |      | |||| | |||||||||| ||| |||| | || | | ||  || ||
 |  |  /----++++-++-+-++++---+++--++---++----++++-----+--+++++++-++-+-+-++--+++\\ || | | ||| ||| |      | |||| | |||||||||\\-+++-++++-+-++-+-+-++--++-+/
 |  |  |    |||| || | ||||   |||  ||   ||    ||||     |  ||||||| || | | ||  |||| || | \\-+++-+++-+------+-++++-+-+++++++++--+++-++++-/ || | | ||  || | 
 |  |  |    |||| || | ||||   |||  ||   ||    ||||     |  ||||||| || |/+-++--++++-++-+---+++-+++-+------+-++++-+-+++++++++--+++\\||||   || | | ||  || | 
 |  |  |    |||| |\\-+-++++---+++--++---++----++++-----+--/|||||| || ||| ||  |||| || |   ||| ||| |      | |||| | |||||||||  |^||||||   || | | ||  || | 
 |  |  |    |||| |  | ||||   |||/-++---++----++++-----+---++++++-++-+++-++--++++-++-+---+++-+++-+----\\ | |||| | |||||||||  ||||||||   || | | ||  || | 
 |  |  |    |||| |  | ||||   |||| ||   ||    ||||     |   |||||| || ||| ||  |||| || |   ||| \\++-+----+-+-++++-+-+++++++++--++++++++---++-+-+-++--/| | 
 |  |  |  /-++++-+--+-++++---++++-++---++----++++-----+---++++++-++-+++-++-\\|||| || |   |||  || |    | | |||| | |||||||||  ||||||||   || | | ||   | | 
 |  |  |  | |||| |  | ||||   |||| ||   ||    ||||     |   |||||| || ||| || ||||| || |   |||  || |    | | |||| | \\++++++++--++++++/|   || | | ||   | | 
 |  |  |  | |||| |  | ||||   |||| ||   ||    ||||     |  /++++++-++-+++-++-+++++-++-+---+++--++\\|    | | |||| |  ||||||||  |||||| |   || | | ||   | | 
 |  |  |  | |||| |  | ||||   |||| ||   ||    ||||     |  |||||||/++-+++-++-+++++-++-+---+++--++++----+-+\\|||| |  ||||||||  |||||| |   || | | ||   | | 
 |  |  | /+-++++-+--+-++++---++++-++---++----++++-----+--++++++++++-+++-++-+++++-++-+-\\ |||  ||||    | |||||| |  ||||||||  |||||| |   || | | ||   | | 
 |  |  | || |||| |  | ||||   |||| ||   \\+----++++-----+--++++++++++-+++-++-+++++-++-+-+-+++--++++----+-++++++-+--++++++/|  |||||| |   || | | ||   | | 
 |  |  | || |\\++-+--+-+/||   |||| ||    |    ||||     |  |||||||||| ||\\-++-+++++-++-+-+-+++--++++----+-++++/| |  |||||| |  |||||| |   || | | ||   | | 
 |  |  | || | || |  | | ||   |||| ||    |    ||||     |  |||||\\++++-++--++-+/||| || | |/+++--++++----+-++++-+-+--++++++-+--++++++-+-\\ || | | ||   | | 
 |/-+--+-++-+-++-+--+-+\\||   |||| ||    |    ||||     |  ||||| |||| ||  || | ||| || | |||||  ||||    | |||\\-+-+--++++++-+--++++++-+-+-++-+-+-++---+-/ 
 || |  | || | || |  | ||||   |||| ||    |    ||||     |  ||||| |||| ||  || | ||| || | |||||  ||||    | |||/-+-+--++++++-+--++++++-+-+-++-+\\| ||   |   
 || |  | || | || |  | ||||   |||| ||    | /--++++-----+--+++++-++++-++--++-+-+++-++-+-+++++--++++----+-++++-+-+--++++++-+--++++++-+-+-++-+++-++---+--\\
 || |  | || | || |  | \\+++---++++-++----+-+--++++-----+--++/|| |||| ||  || | |\\+-++-+-++++/  ||||    | |||| | |  |||||| |  |||||| | | || ||| ||   |  |
 || |  | || | || |  |  |||   |||| ||    | |  ||||   /-+--++-++-++++-++--++-+-+-+-++-+-++++---++++----+-++++-+-+--++++++-+-\\|||||| | | || ||| ||   |  |
 || |  | || \\-++-+--+--+++---++/| ||    | |  ||||   | |  || || |||| ||  || | | | || | ||||  /++++----+-++++-+-+--++++++-+-+++++++-+-+-++\\||| ||   |  |
 || |  | ||   || |  |  |||   || | |\\----+-+--++++---+-+--++-++-++++-++--/| | | | ||/+-++++--+++++----+-++++-+-+--++++++-+-+++++++\\| | |||||| ||   |  |
 || |  | ||   || |  |  |||   || | |     | |  ||||   | |  || || |||| ||   | | | | |||| ||||  |||||    | |||| | |  |||||| | ||||||||| | |||||| ||   |  |
 || |  | ||   || |  \\--+++---++-+-+-----+-+--++++---+-+--++-++-++++-++---+-+-+-+-++++-++++--+++++----+-++++-+-+--+/|||| | ||||||||| | |||||| ||   |  |
 || |  | ||  /++-+-----+++\\  || | \\-----+-+--++++---+-+--++-++-++++-++---+-+-+-+-/||| ||||  |||||    | |||| | |  | |||| | ||||||||| | |||||| ||   |  |
 || |  | ||  |||/+-----++++--++-+----\\  | |  ||||   | |  || || |||| ||   | | | |  ||| ||||  |||||    | |||| | |  | |||\\-+-+++++++++-+-++++++-/|   |  |
 || |  | ||  ||\\++-----++++--++-+----+--+-+--++++---+-+--++-++-++++-++---+-+-+-+--+++-++++--+++++----+-++++-+-+--+-/||  | ||||||||| | ||||||  |   |  |
 || |  ^ ||  || ||     |||| /++-+----+--+-+\\ ||||   | |  || || |||| ||   | | | |  ||| ||||  ||\\++----+-++++-+-+--+--++--+-++++++++/ | ||||||  |   |  |
 || |  | ||  || ||     |||| ||| |    |  | || ||||   \\-+--++-++-++++-++---+-+-+-+--+++-++++--++-++----+-++++-+-+--+--++--+-/|||||||  | ||||||  |   |  |
 || |  | ||/-++-++-----++++\\||| |    |  | || ||||     |  || || |||| |\\---+-+-+-+--+++-++++--++-++----+-++++-+-+--+--++--+--+++/|||  | ||||||  |   |  |
 || |  | ||| |\\-++-----++++++++-+----+<-+-++-++++-----/  || || |||| |    | | | |  ||| ||||  || ||    | ||\\+-+-+--+--+/  |  ||| |||  | v|||||  |   |  |
 \\+-+--+-+++-+--++-----++++++++-+----+--+-++-++++--------++-++-++++-+----+-+-+-+--++/ ||||  || ||/---+-++-+-+-+--+--+---+--+++-+++--+-++++++\\ |   |  |
  | |  | ||| |  ||     |||||||| |    |  | || ||||        || || |||| |    | | | |  |\\--++++--++-+++---+-++-+-+-+--+--+---+--+++-++/  | ||||||| |   |  |
  | | /+-+++-+--++-----++++++++-+----+--+-++-++++----\\   || || \\+++-+----+-+-+-+--+---++++--++-+++---+-++-+-+-+--+--+---+--+/| ||   | ||||||| |   |  |
  | | || |||/+--++-----++++++++-+----+--+-++\\||||    |   || \\+--+++-+----+-+-+-+--+---++++--++-+++---+-++-+-+-+--+--+---+--+-+-++---+-+/||||| |   |  |
/-+-+-++-+++++--++-----++++++++-+----+--+-+++++++----+---++-\\|  \\++-+----+-+-+-+--+---++++--++-+++---+-+/ | | |  |  |   |  | | ||   | | ||||| |   |  |
| | | || |||||  ||     |||||||| |    |  | |||||||    |   || ||   || |    | | | |  \\---++++--++-+++---+-+--+-+-+--+--+---/  | | ||   | | ||||| |   |  |
| | | || |||||  ||     |||||||| |    |  | |||||||    |   || ||   ||/+----+-+-+-+------++++-\\|\\-+++---+-+--+-+-+--+--+------+-+-++---+-+-+++++-+---/  |
| | | || |||||  ||     |||||||| |    |  | |||||||/---+---++-++---++++----+-+-+-+------++++-++--+++---+-+--+-+-+--+--+------+-+-++->-+-+-+++++-+\\     |
| | | || |||||  ||     |||||||| |    |  | ||||||||   |   || ||   ||||    |/+-+-+------++++-++--+++---+-+--+-+-+--+--+------+-+-++---+-+\\||||| ||     |
| | | || |||||/-++-----++++++++-+----+--+-++++++++---+---++-++---++++-\\  ||| |/+------++++-++--+++---+-+--+-+-+--+--+------+-+-++---+-+++++++-++----\\|
| | | || |||||| ||     |||||||| |    |  | ||||||||   |   || ||   |||| |  ||| |||      |||| ||  |||   | |  | | |  |  |      | | ||   | ||||||| ||    ||
| | \\-++-++++++-++-----++++++++-+----+--+-++++++++---+---++-++---+++/ |  ||| |||      |||| ||  |||   | |  | | |  |  |      | | ||   | ||||||| ||    ||
| |   || |||||| ||     |||||||\\-+----+--+-++++++++---+---++-++---+++--+--+++-+++------++++-++--+++---+-/  | | |  |  |      | | ||   | ||||||| ||    ||
| |   || |||||| ||     |||||||  |    |  | \\+++++++---+---++-++---+++--+--+++-+++------++++-++--+++---+----+-+-+--+--+------+-+-++---+-+++++++-++----+/
| |   || |||||| ||     |||||||  |    |  |  |||||||   |   || ||   |||  |  ||| |||      |||| ||  |||   |    | | |  |  |      | | ||   | ||||||| ||    | 
| |   || |||||| ||     |||||||  |    |  |  |||||||   |   || ||   |||  |  ||| ||| /----++++-++--+++---+----+-+-+--+--+------+-+-++--\\| ||||||| ||    | 
| |   || |||||| ||     |||||||  |    |  |  |||\\+++---+---++-++---+++--+--+++-/|| |    |||| ||  |||   |    | | |  |  |      | | ||  || ||||||| ||    | 
| |   || |||||| ||     |||||||  |    |  |  ||| |||   |   |\\-++---+++--+--+++--++-+----++++-++--+++---+----+-+-+--+--+------+-+-+/  || ||||||| ||    | 
| |   || |||||| ||     |||||||  |    |  |  ||| |||   |   |  ||   |||  |  |||  || |    |||| ||  |||  /+----+-+-+--+--+------+-+-+--\\|| ||||||| ||    | 
| |   || |||||| ||     |||||||  |    |  |  ||| |||   |   \\--++---+++--+--+++--++-+----++++-++--/||  ||    | | |  |  |  /---+-+-+--+++-+++++++-++\\   | 
| |   \\+-++++++-++-----+++++++--+----+--+--+++-+++---/      ||   |||  |/-+++--++-+----++++-++---++-\\||    | | |  |  |  |   | | \\--+++-+++/||| |||   | 
| |    | |||||| ||     |||||||  |    |  |  ||| |||          ||   |||  || |||  || |    v||| ||   || |||   /+-+-+--+--+--+---+-+\\   ||| ||| ||| |||   | 
| |    | |||||| ||     |||||||  |    |  \\--+++-+++----------++---+++--++-+++--++-+----++++-++---++-+++---++-+-/  |  |  |   | ||   ||| ||| ||| |||   | 
| \\----+-++++++-++-----/|\\++++--+----+-----+++-+++----------++---+/|  || |||  || |    ||||/++---++-+++---++-+---\\|  |  |   | ||   ||| ||| ||| |||   | 
|      | |||||| \\+------+-++++--+----/     ||| |||          ||   | |  || |||  || |    |||||||   || |||   || |   ||  |  |   | ||   ||| ||| ||| |||   | 
|      | ||||||  |      | ||||  |          ||| |||          ||   | |  || |||  || |    |||||||   || |||   || |   ||  |  |   | ||   ||| ||| ||| |||   | 
|      | ||||||  |    /-+-++++--+------\\   ||| ||v          ||   | |  || |||  || |    |||||||   |\\-+++---++-+---++--+--+---+-++---+++-+++-++/ |||   | 
|      | ||||||  |    | | ||||  |      |   ||| |||          ||   | |  || |||  || |    ||\\++++---+--+++---++-/   ||  |  |   | ||   ||| ||| ||  |||   | 
|      | ||||||  |    | | ||||  |      |   ||| |||          ||   | |  || |||  \\+-+----++-++++---+--+++---++-----++--+--+---+-++---+++-+++-++--+++---/ 
|      \\-++++++--+----+-+-++++--+------+---+++-+++----------++---+-+--++-+++---/ |    || ||||   |  |||   ||     ||  |  |   | ||   ||| ||| ||  |||     
|        ||||||  |    | | ||||  |      |   ||\\-+++----------++---+-+--++-+++-----+----++-++++---+--+++---++-----++--+--+---/ \\+---+++-+++-++--/||     
|     /--++++++--+----+-+-++++--+------+---++--+++\\         |\\---+-+--++-/||     |    || ||||   |  |||   \\+-----++--+--+------/   ||| ||| ||   ||     
|     |  ||||||  |    | | ||||  |      |   ||  ||||         |    | |  ||  ||     |    || ||||   |  |||    |     ||  |  |          ||| ||| ||   ||     
|     |  \\+++++--+----+-+-++++--+------+---++--++++---------+----+-+--++--++-----+----/| ||||   |  |||    \\-----++--+--+----------+++-+++-/|   ||     
|     |/--+++++--+----+-+-++++--+------+---++-\\\\+++---------+----+-+--++--++-----+-----+-++++---+--+++----------++--/  |          ||| |||  |   ||     
|     ||  |||||  |    | | ||||  \\------+---++-+-+++---------+----+-+--++--++-----+-----+-++++---+--++/          ||     |          ||| |||  |   ||     
|     ||  |||||  |    | | ||||         |   || | |||         |    | |  ||  ||     |     | ||||   |  ||           ||     |          ||| |||  |   ||     
|     ||  |||||  |    | | ||||         |   || | |||         |    | |  ||  ||     |     | ||||   |  ||/----------++-----+------\\   ||| |||  |   ||     
|     ||  |||||  |    | | ||||         |   || | |||         |    | \\--++--++-----+-----+-++/|   |  |||          ||     |      |   ||| |||  |   ||     
|/----++--+++++--+----+-+-++++---------+---++-+-+++---------+----+----++--++-----+\\    | \\+-+---+--+++----------++-----+------+---+++-/||  |   ||     
||    ||  |||||  |    \\-+-++++---------/   || | |||         |    |    ||  ||     ||    |  | |   |  |||          ||     |      |   |||  ||  |   ||     
||    ||  |||||  |      | ||||             || | |||         |    |    ||  ||     ||    |  | |   |  |||          ||     \\------+---+++--++--+---+/     
||    ||  |||||  |      | ||\\+-------------/| | |||         |    |    ||  || /---++----+--+-+---+--+++---\\      ||            |   |||  ||  |   |      
||    |\\--+++++--+------+-++-+--------------+-/ |||         |    |    ||  || |   ||    |  | |   |  |||   |      ||            |   |||  ||  |   |      
||    |   |||||  |      | || |  /-----------+\\  |\\+---------+----+----++--++-+---++----+--+-+---+--+++---+------++------------+---+++--++--+---/      
||    |   |\\+++--+------+-+/ |  |   /-------++--+-+--\\      |    |    ||  || |   ||    |  | |   |  |||   |      ||            |   |||  ||  |          
||    |  /+-+++--+------+-+--+--+---+-------++--+-+--+------+----+----++--++-+---++----+--+-+---+--+++\\  |      ||            |   |||  ||  |          
||    |  || |||  |      | |  |  |   |       ||  | |  |      |    |    ||  || |   ||    |  | |   |  ||\\+--+------++------------/   |||  |^  |          
||    |  || |||  |      | |  \\--+---+-------++--+-+--+------+----/    ||  || |   ||    |  | |   |  || |  |      ||                |||  ||  |          
||    |  || |||  |      | |     |   |       ||  | |  |      |         ||  || |   ||    |  | |   |  || |  |      ||                |||  ||  |          
||    \\--++-+++--+------+-+-----+---+-------++--+-/  |      |         ||  || |   ||    \\--+-+---+--++-+--+------++----------------++/  ||  |          
||       || |||  |      \\-+-----+---+-------++--/    |      |         ||  || |   ||       | |   |  || |  |      |\\----------------++---++->/          
||       || ||\\--+--------+-----+---+-------++-------+------+-<-------/|  || |   ||       | \\---+--++-+--+------+-----------------++---+/             
||       |\\-++---+--------+-----+---+-------++-------+------+----------+--+/ |   ||       |     |  || |  |      |                 ||   |              
\\+-------+--++>--+--------+-----+---+-------++-------+------/          |  |  \\---++-------+-----+--++-+--/      |                 ||   |              
 |       |  ||   \\--------+-----+---+-------++-------+-----------------+--+------++-------+-----/  || |         |                 ||   |              
 |       |  \\+------------+-----+---+-------/|       |                 |  \\------++-------+--------++-+---------+-----------------++---/              
 |       |   \\------------/     \\---+--------/       |                 |         \\+-------+--------++-+---------+-----------------+/                  
 |       |                          |                |                 \\----------+-------+--------/| |         |                 |                   
 \\-------+--------------------------+----------------+----------------------------/       |         \\-+---------+-----------------/                   
         \\--------------------------+----------------+------------------------------------+-----------/         |                                     
                                    \\----------------/                                    \\---------------------/                                     """

initMine : DataSource -> Array2D Char
initMine dataSource = 
  let 
    data = 
      case dataSource of 
        Sample -> sample 
        Sample2 -> sample2
        Input -> input 
  in 
    data |> String.split "\n" |> List.map (String.toList) |> Array2D.fromList

toIndexedList : Array2D Char -> List (Pos, Char)
toIndexedList mine = 
  let 
    yRange = List.range 0 (Array2D.rows mine - 1)
    xRange = List.range 0 (Array2D.columns mine - 1)
  in 
    yRange |> List.concatMap (\y -> xRange |> List.map (\x -> ((x, y), Array2D.get y x mine |> Maybe.withDefault ' ')))

isCart : Char -> Bool 
isCart ch = 
  let 
    symbols = ['^', '<', 'v', '>']
  in 
    symbols |> List.member ch

isBlank : Char -> Bool 
isBlank ch = 
  ch == ' '

charToDir : Char -> Dir 
charToDir ch = 
  case ch of 
    '^' -> N
    '<' -> W
    'v' -> S
    '>' -> E
    _ -> N

findCarts : Array2D Char -> List Cart
findCarts mine = 
  let 
    indexed = toIndexedList mine 
  in 
    indexed |> List.filterMap (\(pos, ch) -> if isCart ch then Just { dir = charToDir ch, pos = pos, switches = Left } else Nothing)

moveForward : Dir -> Pos -> Pos 
moveForward dir (x, y) = 
  case dir of 
    N -> (x, y - 1)
    W -> (x - 1, y)
    S -> (x, y + 1)
    E -> (x + 1, y)

initModel : DataSource -> Model 
initModel dataSource = 
  let 
    mine = initMine dataSource
    carts = findCarts mine
  in 
    { mine = mine
    , carts = carts
    , dataSource = dataSource
    , paused = True
    , finished = False 
    , tickInterval = defaultTickInterval
    , counter = 0
    , message = ""
    , debug = "" }

init : () -> (Model, Cmd Msg)
init _ =
  (initModel Input, Cmd.none)

-- UPDATE

type Msg = 
  Tick 
  | Step 
  | TogglePlay 
  | Faster 
  | Slower 
  | Clear 
  | UseSample 
  | UseInput 

getAllPositions : Array2D Char -> List Pos
getAllPositions mine = 
  let
    ys = List.range 0 (Array2D.rows mine - 1)
    xs = List.range 0 (Array2D.columns mine - 1)
  in 
    ys |> List.concatMap (\y -> xs |> List.map (\x -> (x, y)))

getNestedPositions : Array2D Char -> List (List Pos)
getNestedPositions mine = 
  let
    ys = List.range 0 (Array2D.rows mine - 1)
    xs = List.range 0 (Array2D.columns mine - 1)
  in 
    ys |> List.map (\y -> xs |> List.map (\x -> (x, y)))

getNextPos : Dir -> Pos -> Pos 
getNextPos dir (x, y) = 
  case dir of 
    N -> (x, y - 1)
    W -> (x - 1, y)
    S -> (x, y + 1)
    E -> (x + 1, y)

turnLeft : Dir -> Dir 
turnLeft dir = 
  case dir of 
    N -> W
    W -> S
    S -> E 
    E -> N

turnRight : Dir -> Dir 
turnRight dir = 
  case dir of 
    N -> E
    W -> N
    S -> W 
    E -> S

straightAhead : Dir -> Dir 
straightAhead dir = dir

turn : Junction -> (Dir -> Dir)
turn switches = 
  case switches of 
    Left -> turnLeft
    Forward -> straightAhead
    Right -> turnRight

getNextDir : Char -> Cart -> Dir 
getNextDir nextSymbol cart =
  let 
    dir = cart.dir 
    switches = cart.switches
  in 
    case nextSymbol of 
      '/' -> 
        case dir of 
          N -> turnRight dir
          W -> turnLeft dir 
          S -> turnRight dir 
          E -> turnLeft dir 
      '\\' ->
        case dir of 
          N -> turnLeft dir
          W -> turnRight dir 
          S -> turnLeft dir 
          E -> turnRight dir 
      '+' ->
        turn switches dir 
      _ -> 
        dir 

getNextSwitches : Char -> Junction -> Junction 
getNextSwitches nextSymbol switches = 
  case nextSymbol of 
    '+' -> 
      case switches of 
        Left -> Forward
        Forward -> Right 
        Right -> Left 
    _ -> 
      switches

moveCart : Array2D Char -> Cart -> Cart
moveCart mine cart = 
  let 
    (x, y) = getNextPos cart.dir cart.pos 
    nextSymbol = Array2D.get y x mine |> Maybe.withDefault ' '
    nextDir = getNextDir nextSymbol cart 
    nextSwitches = getNextSwitches nextSymbol cart.switches
  in 
    { dir = nextDir, pos = (x, y), switches = nextSwitches }

updateClear : Model -> Model
updateClear model = 
  initModel model.dataSource

updateStep : Model -> Model
updateStep model = model 

updateTogglePlay : Model -> Model
updateTogglePlay model = 
  if model.finished then 
    let 
      m = initModel model.dataSource
    in 
      {m | paused = False }
  else 
    { model | paused = not model.paused }

updateUseSample : Model -> Model
updateUseSample model = 
  initModel Sample 

updateUseInput : Model -> Model
updateUseInput model = 
  initModel Input 

update : Msg -> Model -> (Model, Cmd Msg)
update msg model =
  case msg of
    Clear -> 
      (updateClear model, Cmd.none)
    Tick ->
      (updateStep model, Cmd.none)
    Step ->
      (updateStep model, Cmd.none)
    Faster -> 
      ({model | tickInterval = model.tickInterval / 2 }, Cmd.none)
    Slower -> 
      ({model | tickInterval = model.tickInterval * 2 }, Cmd.none)
    TogglePlay -> 
      (updateTogglePlay model, Cmd.none)
    UseSample -> 
      (updateUseSample model, Cmd.none)
    UseInput -> 
      (updateUseInput model, Cmd.none)

-- SUBSCRIPTIONS

subscriptions : Model -> Sub Msg
subscriptions model =
  let 
    tickSub = if model.paused then Sub.none else Time.every model.tickInterval (\_ -> Tick)
  in 
    tickSub

-- VIEW

toCharElement : Array2D Char -> Pos -> Html Msg 
toCharElement mine (x, y) = 
    case Array2D.get y x mine of 
      Nothing -> Html.text "?"
      Just ch -> 
        if isCart ch then 
          Html.span [ Html.Attributes.style "background-color" "#CCCCCC" ] [ Html.text (String.fromChar ch) ]
        else if isBlank ch then 
          Html.span [ Html.Attributes.style "color" "#FFFFFF" ] [ Html.text "." ]
        else 
          Html.text (String.fromChar ch)

view : Model -> Document Msg
view model = 
  { title = "Advent of Code 2018 | Day 13: Mine Cart Madness"
  , body = [ viewBody model ] }

viewBody : Model -> Html Msg
viewBody model =
  let
    mine = model.mine
    nestedPositions = getNestedPositions mine
    nestedElements = nestedPositions |> List.map (\positions -> positions |> List.map (toCharElement mine))
    elements = nestedElements |> List.foldr (\a b -> List.append a (Html.br [] [] :: b)) []      
    textFontSize = 
      case model.dataSource of 
        Sample -> "32px"
        Sample2 -> "32px"
        Input -> "9px"
  in 
    Html.table 
      [ Html.Attributes.style "width" "1080px"
      , Html.Attributes.style "font-family" "Courier New" ]
      [ Html.tr 
          [] 
          [ Html.td 
              [ Html.Attributes.align "center"
              , Html.Attributes.style "font-family" "Courier New"
              , Html.Attributes.style "font-size" "32px"
              , Html.Attributes.style "padding" "20px"]
              [ Html.div [] [Html.text "Advent of Code 2018" ]
              , Html.div [] [Html.text "Day 13: Mine Cart Madness" ] ] ]
      , Html.tr 
          []
          [ Html.td 
              [ Html.Attributes.align "center"
              , Html.Attributes.style "padding-bottom" "10px" ]
              [ Html.text " ["
              , Html.a [ Html.Attributes.href "../../2024/"] [ Html.text "2024" ]
              , Html.text "] " 
              , Html.text " ["
              , Html.a [ Html.Attributes.href "../../2023/"] [ Html.text "2023" ]
              , Html.text "] "
              , Html.text " ["
              , Html.a [ Html.Attributes.href "../../2022/"] [ Html.text "2022" ]
              , Html.text "] "
              , Html.text " ["
              , Html.a [ Html.Attributes.href "../../2021/"] [ Html.text "2021" ]
              , Html.text "] "
              , Html.text " ["
              , Html.a [ Html.Attributes.href "../../2020/"] [ Html.text "2020" ]
              , Html.text "] "
            ] ]
      , Html.tr 
          []
          [ Html.td 
              [ Html.Attributes.align "center"
              , Html.Attributes.style "padding-bottom" "10px" ]
              [ Html.a 
                [ Html.Attributes.href "https://adventofcode.com/2018/day/13" ] 
                [ Html.text "https://adventofcode.com/2018/day/13" ]
            ] ]
      , Html.tr 
          []
          [ Html.td 
              [ Html.Attributes.align "center"
              , Html.Attributes.style "font-family" "Courier New"
              , Html.Attributes.style "font-size" "16px" ]
              [ 
                Html.input 
                [ Html.Attributes.type_ "radio", onClick UseInput, Html.Attributes.checked (model.dataSource == Input) ] 
                []
              , Html.label [] [ Html.text "Input" ]
              , Html.input 
                [ Html.Attributes.type_ "radio", onClick UseSample, Html.Attributes.checked (model.dataSource == Sample) ] 
                []
              , Html.label [] [ Html.text "Sample" ]
            ] ]
      , Html.tr 
          []
          [ Html.td 
              [ Html.Attributes.align "center"
              , Html.Attributes.style "padding" "10px" ]
              [ Html.button 
                [ Html.Attributes.style "width" "80px", onClick Clear ] 
                [ Html.text "Clear"]
              , Html.button 
                [ Html.Attributes.style "width" "80px", onClick Slower ] 
                [ text "Slower" ]
              , Html.button 
                [ Html.Attributes.style "width" "80px", onClick TogglePlay ] 
                [ if model.paused then text "Play" else text "Pause" ] 
              , Html.button 
                [ Html.Attributes.style "width" "80px", onClick Faster ] 
                [ text "Faster" ]
              , Html.button 
                [ Html.Attributes.style "width" "80px", onClick Step ] 
                [ Html.text "Step" ]
            ] ]
      , Html.tr 
          []
          [ Html.td 
              [ Html.Attributes.align "center"
              , Html.Attributes.style "background-color" "white" 
              , Html.Attributes.style "font-family" "Courier New"
              , Html.Attributes.style "font-size" "24px"
              , Html.Attributes.style "width" "200px" ] 
              [ 
                Html.div [] [ Html.text "?" ]
              , Html.div [] [ Html.text "?" ]
              ] ]
      , Html.tr 
          []
          [ Html.td 
              [ Html.Attributes.align "center"
              , Html.Attributes.style "background-color" "white" 
              , Html.Attributes.style "font-family" "Source Code Pro, monospace"
              , Html.Attributes.style "font-size" textFontSize
              , Html.Attributes.style "padding" "10px"
              , Html.Attributes.style "width" "200px" ] 
              [ 
                Html.div [] elements
              ] ] ]
