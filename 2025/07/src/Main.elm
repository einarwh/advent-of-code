module Main exposing (..)

{- Advent of Code 2025. Day 07: Laboratories. -}

import Browser 
import Html exposing (Html)
import Html.Attributes
import Html.Events exposing (onClick)
import Set exposing (Set)
import Time

defaultTickInterval : Float
defaultTickInterval = 50

chamberWidth : Int 
chamberWidth = 7 

-- MAIN

main =
  Browser.element
    { init = init
    , view = view
    , update = update
    , subscriptions = subscriptions }

-- MODEL

type DataSource = Input | Sample

type alias Pos = (Int, Int)

type alias State = 
  { count : Int 
  , seen : Set Pos }

type alias Model = 
  { dataSource : DataSource
  , width : Int 
  , height : Int 
  , steps : List State 
  , accumulated : State  
  , lines : List (List Char) 
  , removed : Int 
  , paused : Bool 
  , finished : Bool 
  , tickInterval : Float 
  , debug : String }

sample : String
sample = """.......S.......
...............
.......^.......
...............
......^.^......
...............
.....^.^.^.....
...............
....^.^...^....
...............
...^.^...^.^...
...............
..^...^.....^..
...............
.^.^.^.^.^...^.
..............."""

input : String
input = """......................................................................S......................................................................
.............................................................................................................................................
......................................................................^......................................................................
.............................................................................................................................................
.....................................................................^.^.....................................................................
.............................................................................................................................................
....................................................................^...^....................................................................
.............................................................................................................................................
...................................................................^.^.^.^...................................................................
.............................................................................................................................................
..................................................................^.^.^...^..................................................................
.............................................................................................................................................
.................................................................^.^.^.^.^.^.................................................................
.............................................................................................................................................
................................................................^.^.^.^.^...^................................................................
.............................................................................................................................................
...............................................................^.^.^...^.^.^.^...............................................................
.............................................................................................................................................
..............................................................^.^.^.^.^.^...^.^..............................................................
.............................................................................................................................................
.............................................................^.^.......^...^.^.^.............................................................
.............................................................................................................................................
............................................................^.^.^.^.^...^.^.^.^.^............................................................
.............................................................................................................................................
...........................................................^.^.^.^.^.^.^.^...^.^.^...........................................................
.............................................................................................................................................
..........................................................^.....^.^.^.^.......^.^.^..........................................................
.............................................................................................................................................
.........................................................^...^.^.^.^.^...^.^.^.....^.........................................................
.............................................................................................................................................
........................................................^.....^.^.....^.^.^.^.....^.^........................................................
.............................................................................................................................................
.......................................................^...^.^.^.......^...^...^.^.^.^.......................................................
.............................................................................................................................................
......................................................^.^.^.^.^.^.^.^.^.^.^.^.^...^.^.^......................................................
.............................................................................................................................................
.....................................................^.^.^.^...^...^...........^.^.^.^.^.....................................................
.............................................................................................................................................
....................................................^.^...^.^.....^.^...^.^.^.^.^...^...^....................................................
.............................................................................................................................................
...................................................^.^...^...^...^...^.^.^.^.^...^.^.^.^.^...................................................
.............................................................................................................................................
..................................................^.....^.^.....^.^.^.^.^.^...^.^.....^.^.^..................................................
.............................................................................................................................................
.................................................^.^.^...^.^.^.....^.^.^.^.^.....^.^.^...^.^.................................................
.............................................................................................................................................
................................................^...^...^...^.^.^.........^.^.^.^.^.^.......^................................................
.............................................................................................................................................
...............................................^.^.^.^...^.^.^.......^.^.........^.^.^.^.....^...............................................
.............................................................................................................................................
..............................................^.^.^...^.^.^.^.^.^...^.^.....^.......^.^.^...^.^..............................................
.............................................................................................................................................
.............................................^.^.^.^.^.^...^.^.^.....^.^.^.^.^.^.^.....^.^.^.^.^.............................................
.............................................................................................................................................
............................................^.^.^...^.^.^.^.^.^.^...^.^.^.^...^.^.^.^.^.^...^.^.^............................................
.............................................................................................................................................
...........................................^.^.^.^.^.^.^.^.^.^...^.^.............^.^.^.........^.^...........................................
.............................................................................................................................................
..........................................^.^.^.....^.^.^.^...^.^.^.^.^.^...^.^.^.^.^.^...^.^.^...^..........................................
.............................................................................................................................................
.........................................^.^...^.^.^.^.^.^.......^.^...^.^.^.^...^...^.^.^...^.^.^.^.........................................
.............................................................................................................................................
........................................^.^.^.^.^.^...^...^.^.^.....^.^.^...^.^.^.^.^.^...^.^.^...^.^........................................
.............................................................................................................................................
.......................................^.^.^.^.^.^.^.^.^.^.^.^.^.^...^.^.^.^.......^...^.^...^.^.^...^.......................................
.............................................................................................................................................
......................................^.^.^.^...^.^...^.^.^.^.^.^.^.^.^.....^.^...^.^.....^.^.^...^...^......................................
.............................................................................................................................................
.....................................^.^.^.^.^.^.^.^...^.^.^...^.....^.^...^.^.^.^.....^.^...^...^.^.^.^.....................................
.............................................................................................................................................
....................................^...^.^.^.....^.^.^.^.^...^...^...^.^.^.^.^.^.^...^.^.^.^.^...^...^.^....................................
.............................................................................................................................................
...................................^...^...^...^.^.^.....^.^...^.^.^.^.^.....^.^.^.^.^.^.....^...^.^.^...^...................................
.............................................................................................................................................
..................................^.^.^.^.^...^.....^.....^.......^.^.....^.^...^...^.^.^...^.....^.^.^.^.^..................................
.............................................................................................................................................
.................................^.^.....^.^.^.^.......^.......^.^.^.^.^.^...^.^...^.^.^...^...^.^...^.....^.................................
.............................................................................................................................................
................................^.^.^.^.^...^.^.^...^.^.^.^.^.^.^.^...^.^.^.^.....^.^.^.....^.^.^.^...^.....^................................
.............................................................................................................................................
...............................^.^...^.^.^...^...^.^.....^.....^.^.^.^...^.....^...^...^...^.^.^.^.^.....^.^.^...............................
.............................................................................................................................................
..............................^.^.....^.^.^.^...^.^.^.^.^...^.^.^.^.^.^.^.^.^.^.^.^.......^.^.^.....^...^...^.^..............................
.............................................................................................................................................
.............................^.^.^.^.........^.....^.^.^...^...^.^.^.^.^...^...^.^.^.^.^.^.^...^.^.^.^...^.^...^.............................
.............................................................................................................................................
............................^.^.^.^.^.^.^.^...^.^.....^.^...^.^.^.^.^.....^.^.^.^...^.^.^.^.^...^...^...^...^.^.^............................
.............................................................................................................................................
...........................^.^...^.^.^.^.^.^...^.^.^.....^...^.^.^.^.^...^...^.^...^.^.......^.^.^...^.^.^.^.^.^.^...........................
.............................................................................................................................................
..........................^.^...^.^.^.^.^.^.^.........^.^...^.^.^.^.^.^.^.......^.^.^...^.^...^...^.^.^.^.^...^.^.^..........................
.............................................................................................................................................
.........................^.....^.^.^.^.^.^...^.^.^.^.....^.^.^...^.^.....^.^.^.^.^.^...^...^.^.....^.^.....^.^.^.^.^.........................
.............................................................................................................................................
........................^...^...^.^.^.^.^.^.....^.^.^.^.^.^.^.^.^.^.....^.^...^...^...^.^.^.^.^.^.......^.^.^.^.^...^........................
.............................................................................................................................................
.......................^.^.^...^.^.......^.^.^.^.^.^...^.^.......^.^.^...^.^...^.^.^.^.^...^.^.^.^...^.^.^.^.^.^.^.^.^.......................
.............................................................................................................................................
......................^.^.^.^...^.^.^.^.^.^.^...^.......^.^...^...^...^...^...^...^.....^...^.^.^.^...^.^.^...^.^.^.^.^......................
.............................................................................................................................................
.....................^.^.^...^.^...^.^...^.....^...^.^.^.^.....^.^...^.^.^.^.....^...^.......^.^.^...^.....^.^.^.....^.^.....................
.............................................................................................................................................
....................^.^.^.^.^.^.^.^...^.^.^.^.^.^.^.....^...^.^.^.^.^...^.^.^.^.^.^.^...^.^.......^...^.^.^.^.^.^.^.....^....................
.............................................................................................................................................
...................^.^.....^.....^...^.^...^...^...^.^.^...^.......^.^...^...^.^.^.^.^.^.^.^...^.^.^.^.^...^.^...^...^.^.^...................
.............................................................................................................................................
..................^...^.^.^.^.^.^.^.^.^.^.^.^.....^...^...^...^.^.^.^.^.^.^.^.^...^.....^...^...^.^.^.^.^.....^...^.^.^.^.^..................
.............................................................................................................................................
.................^.^.^.^.....^...^.^.^.^.^.^.^.^.^.^...^.^.^.^.^.^.^.....^.^.^...^.^.^...^.......^.....^.^...^...^.......^.^.................
.............................................................................................................................................
................^.^...^.....^.^...^.^...^.^.^...^.^.^.^...^.^.^.^.....^.^...^.^...^.^...^.^.....^.^.^.....^.^.^.^.^.^...^...^................
.............................................................................................................................................
...............^.^.....^.^.^.^.^.^.^.^...^.^...^.^...^.^.^...^.^.....^.^...^.^.^.^.^.........^.^...^.^.^...^.^.^.....^...^.^.^...............
.............................................................................................................................................
..............^.^.^.^.^.^.^.^.^.^.^...^.^.^.^.^.^.^.^.....^.^.^...^.^.^.^.^.^.^.^...^.^.^.^.^.^.^.^.........^.^.^.^.^...^.^.^.^..............
.............................................................................................................................................
.............^.^.^.^.^.^...^.^.^.^...^.^.^.^.^.........^.^...^.^.^.....^.^...^.^.^...^.^.^...^.^...^...^...^...^.^.^.^.^.^...^.^.............
.............................................................................................................................................
............^.^.....^.^...^.^.^.^.......^.^.^.^.^.....^.^.^.^.^.^.^.^.^.^.^...^.^.^.^.^...^.^.^...^.^...^.^.^...^.^.^.^.^.^.^...^............
.............................................................................................................................................
...........^.^.^...^.^.^.^.^...^...^.^.^.....^.^...^.^.^...^.^.^...^.^.^.^...^...^.^.....^...^.^.....^.^.^.^.^.^.^.^...^.......^.^...........
.............................................................................................................................................
..........^.^.^.^.^.^...^...^.^.^.^.^.^.....^.^.^.^.^...^...^.^.^...^.^.^.^.^...^.^.^.^.....^.^.^.^.^.^.^.^.^.^.^.....^.^.^.......^..........
.............................................................................................................................................
.........^.^.^.^.^...^.^...^...^.....^.^...^.^...^.^.^.^.^.^.........^.^.^.^.^...^.^.^...^.^.^.^.^...^.....^.^.^.^.^.^.^.^.^.^.^...^.........
.............................................................................................................................................
........^...^.....^.^.......^...^.^.^.^.....^.^.^.^.......^.^...^.^.^.^.^.^.^.^.^.^.^.....^...^.^.....^...^.^.^.^.^...^...^.....^.^.^........
.............................................................................................................................................
.......^.^.^.^.^.^...^.^.^...^.^...^...^.......^.^.^.^.^.^...^.^.^.^.^...^.^.^.^.^.^.^.^.^.^.^...^.^.^.^.^.^.^.^.^.....^.^.^.^...^.^.^.......
.............................................................................................................................................
......^.^.^.^.......^.^.^.^.....^.^.^...^.^.^.^.^...^...^...^.^.^.........^.....^.^.^.^.^.^.....^.......^.^.......^.....^.^.^.^.^.....^......
.............................................................................................................................................
.....^.^.^.^.....^.^.^...^...^.......^.^...^.....^.^.^.^.^...^...^.^.^.^...^.^.^.^.^.^.^.^.^...^.......^...^.........^.^.^.^...^.^...^.^.....
.............................................................................................................................................
....^.^.^.^.^.^.^.^.^.^...^.^...^.^.^...^.^.^.^...^.^...^.^.^.^...^...^.^.^.^.^.^.^...^.^.^...^.......^.^.^.^.^.^.^.^.^.^.^.^...^.^.^...^....
.............................................................................................................................................
...^...^.^.^.^...^.^...^.^.....^.^.^.^.^.^.^.^.^.....^.^.^...^...^.^.^.^.^...^...^.^.^.^...^.^.^.^.^...^...^.^.^.^.^...^.^.^.^.....^.....^...
.............................................................................................................................................
..^.^...^...^.^.^.^...^.^.^...^.^.^.^.^.....^...^...^.^.^.....^.^.....^.^.^...^.....^.^...^.^.^.^...^.......^.^.....^.^.......^.^.......^.^..
.............................................................................................................................................
.^...^.^.^.^.^.^.....^.^.^.........^.^...^.^.^.^...^.^.^.^...^.^.........^.^...^.....^...^.^.^.^.^.^.^...^...^.^.^.........^.^.^.^.^.^.^.^.^.
............................................................................................................................................."""

read : DataSource -> String
read dataSource = 
  case dataSource of 
    Input -> input
    Sample -> sample

initModel : DataSource -> Model 
initModel dataSource = 
  let 
    data = read dataSource
    symbolLists = data |> String.split "\n" |> List.map String.toList
  in 
    { dataSource = dataSource
    , width = 0 
    , height = 0
    , steps = []
    , accumulated = { count = 0, seen = Set.empty }
    , lines = symbolLists
    , removed = 0
    , paused = True
    , finished = False  
    , tickInterval = defaultTickInterval 
    , debug = "?" }

init : () -> (Model, Cmd Msg)
init _ =
  (initModel Sample, Cmd.none)

-- UPDATE

type Msg = 
  Tick 
  | Step 
  | TogglePlay 
  | Faster 
  | Slower 
  | Clear 
  | UseInput
  | UseSample

getNestedPositions : Int -> Int -> List (List Pos)
getNestedPositions rows columns = 
  let
    ys = List.range 0 (rows - 1) 
    xs = List.range 0 (columns - 1)
  in 
    ys |> List.map (\y -> xs |> List.map (\x -> (x, y)))

updateClear : Model -> Model
updateClear model = 
  initModel model.dataSource

updateStep : Model -> Model
updateStep model = 
  case model.steps of 
    [] -> { model | paused = True, finished = True }
    step :: rest -> 
      let 
        a = model.accumulated
        nextAcc = { count = a.count + step.count, seen = Set.union a.seen step.seen }
        debug = model.steps |> List.length |> String.fromInt 
      in 
        { model | steps = rest, accumulated = nextAcc, debug = debug }

splitCount : List State -> Set Int -> Int -> List (List Char) -> List State
splitCount acc beams depth lines = 
  case lines of 
    [] -> acc |> List.reverse 
    h :: t -> 
      let 
        indexes = 
          h |> List.indexedMap (\i -> \c -> (i, c)) 
            |> List.filterMap (\(i, c) -> if c == '^' then Just i else Nothing)
        collisions = beams |> Set.filter (\b -> indexes |> List.member b)
        uncollisions = Set.diff beams collisions
        splitBeams = Set.union (collisions |> Set.map (\b -> b - 1)) (collisions |> Set.map (\b -> b + 1))
        nextBeams = uncollisions |> Set.union splitBeams 
        seen = nextBeams |> Set.union collisions |> Set.map (\b -> (b, depth))
        state = { count = Set.size collisions, seen = seen }
      in 
        splitCount (state :: acc) nextBeams (depth + 1) t 

indexOf : Int -> a -> List a -> Maybe Int 
indexOf ix it lst =
  case lst of 
    [] -> Nothing 
    h :: t -> 
      if h == it then Just ix else indexOf (ix + 1) it t 

solve : List (List Char) -> List State 
solve lines = 
  case lines of 
    [] -> [] 
    h :: t -> 
      case indexOf 0 'S' h of 
        Nothing -> []
        Just ix -> 
          let 
            initState = { count = 0, seen = Set.empty |> Set.insert (ix, 0) }
            beams = Set.empty |> Set.insert ix 
          in 
            splitCount [ initState ] beams 1 lines 

updateTogglePlay : Model -> Model
updateTogglePlay model = 
  if model.paused then 
    if model.steps == [] then 
      let 
        steps = solve model.lines 
        debug = steps |> List.length |> String.fromInt
      in 
        { model | paused = False, steps = steps, accumulated = { count = 0, seen = Set.empty }, debug = debug } 
    else 
      { model | paused = False }
  else 
    { model | paused = True }

update : Msg -> Model -> (Model, Cmd Msg)
update msg model =
  case msg of
    Clear -> 
      (updateClear model, Cmd.none)
    Tick ->
      (updateStep model, Cmd.none)
    Step ->
      (updateStep model, Cmd.none)
    Faster -> 
      ({model | tickInterval = model.tickInterval / 2 }, Cmd.none)
    Slower -> 
      ({model | tickInterval = model.tickInterval * 2 }, Cmd.none)
    TogglePlay -> 
      (updateTogglePlay model, Cmd.none)
    UseInput -> 
      (initModel Input, Cmd.none)
    UseSample -> 
      (initModel Sample, Cmd.none)

-- SUBSCRIPTIONS

subscriptions : Model -> Sub Msg
subscriptions model =
  let 
    tickSub = if model.paused then Sub.none else Time.every model.tickInterval (\_ -> Tick)
  in 
    tickSub

-- VIEW

toCharElement : Set Pos -> Pos -> String -> Html Msg 
toCharElement seen pos symbol = 
  let
    cssClass =
      if Set.member pos seen then 
        if symbol == "^" || symbol == "S" then "draw-red adaptive" else "draw-green adaptive"
      else 
        "draw-empty adaptive"
    sym = 
      if symbol == "." && Set.member pos seen then 
        "|"
      else
        symbol  
  in
    Html.span [ Html.Attributes.class cssClass ]  [ Html.text sym ]

selectSymbol : Set Pos -> Pos -> String 
selectSymbol rolls pos = 
  if Set.member pos rolls then "@" else "."

view : Model -> Html Msg
view model =
  let
    seen = model.accumulated.seen
    nestedElements = 
      model.lines |> List.indexedMap (\y -> \line -> line |> List.indexedMap (\x -> \ch -> toCharElement seen (x, y) (String.fromChar ch)))
    elements = nestedElements |> List.foldr (\a b -> List.append a (Html.br [] [] :: b)) []    
    textFontSize =
      case model.dataSource of 
        Sample -> "24px"
        Input -> "8px"  in 
    Html.table 
      [ Html.Attributes.align "center"
      , Html.Attributes.style "width" "100%"
      , Html.Attributes.style "font-family" "Courier New" ]
      [ Html.tr 
          [] 
          [ Html.td 
              [ Html.Attributes.align "center"
              , Html.Attributes.style "font-family" "Courier New"
              , Html.Attributes.style "font-size" "32px"
              , Html.Attributes.style "padding" "10px"]
              [ Html.div [] [Html.text "Advent of Code 2025" ]
              , Html.div [] [Html.text "Day 7: Laboratories" ] ] ]
      , Html.tr 
          []
          [ Html.td 
              [ Html.Attributes.align "center"
              , Html.Attributes.style "padding-bottom" "10px" ]
              [ Html.a 
                [ Html.Attributes.href "https://adventofcode.com/2025/day/7" ] 
                [ Html.text "https://adventofcode.com/2025/day/7" ]
            ] ]
      , Html.tr 
          []
          [ Html.td 
              [ Html.Attributes.align "center" ]
              [ 
                Html.input 
                [ Html.Attributes.type_ "radio", onClick UseInput, Html.Attributes.checked (model.dataSource == Input) ] 
                []
              , Html.label [] [ Html.text "Input" ]
              , Html.input 
                [ Html.Attributes.type_ "radio", onClick UseSample, Html.Attributes.checked (model.dataSource == Sample) ] 
                []
              , Html.label [] [ Html.text "Sample" ]
            ] ]
      , Html.tr 
          []
          [ Html.td 
              [ Html.Attributes.align "center"
              , Html.Attributes.style "padding" "10px" ]
              [ Html.button 
                [ Html.Attributes.style "width" "80px", onClick Clear ] 
                [ Html.text "Reset" ]
              , Html.button 
                [ Html.Attributes.style "width" "80px", onClick Slower ] 
                [ Html.text "Slower" ]
              , Html.button 
                [ Html.Attributes.style "width" "80px", onClick TogglePlay ] 
                [ if model.paused then Html.text "Play" else Html.text "Pause" ] 
              , Html.button 
                [ Html.Attributes.style "width" "80px", onClick Faster ] 
                [ Html.text "Faster" ]
              , Html.button 
                [ Html.Attributes.style "width" "80px", onClick Step ] 
                [ Html.text "Step" ]
            ] ]
      , Html.tr 
          []
          [ Html.td 
              [ Html.Attributes.align "center"
              , Html.Attributes.style "font-family" "Courier New"
              , Html.Attributes.style "font-size" "1.2rem"
              , Html.Attributes.style "padding-top" "10px" ] 
              [ 
                Html.div [] [ Html.text (String.fromInt model.accumulated.count) ]
              ] ]
      , Html.tr 
          []
          [ Html.td 
              [ Html.Attributes.align "center"
              , Html.Attributes.style "font-family" "Source Code Pro, monospace"
              , Html.Attributes.style "font-size" textFontSize
              , Html.Attributes.style "padding" "10px" ] 
              [ 
                Html.div [
                  Html.Attributes.align "center" 
                , Html.Attributes.style "max-width" "100%"
                ] elements
              ] ] 
      , Html.tr 
          []
          [ Html.td 
              [ Html.Attributes.align "center"
              , Html.Attributes.style "font-family" "Source Code Pro, monospace"
              , Html.Attributes.style "font-size" "24px"
              , Html.Attributes.style "padding" "0px" ] 
              [ 
                -- Html.div [] [ Html.text (model.moves |> List.length |> String.fromInt ) ]
              -- , Html.div [] [ Html.text (String.fromInt model.position) ]
                Html.div [] [ Html.text model.debug ]
              -- , Html.div [] [ Html.text model.message ]
              ] ] 
              ]
